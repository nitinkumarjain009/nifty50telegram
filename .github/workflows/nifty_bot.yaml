name: Nifty Bot Analysis Scheduler
on:
  schedule:
    # Run at 9:15 AM and 3:45 PM IST on weekdays (3:45 AM and 10:15 AM UTC)
    - cron: '45 3,10 * * 1-5'
  
  # Allow manual trigger from GitHub Actions tab
  workflow_dispatch:
jobs:
  run-nifty-bot:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies and local package
        run: |
          python -m pip install --upgrade pip
          
          # Install dependencies
          if [ -f requirements.txt ]; then 
            pip install -r requirements.txt
          else 
            pip install requests pandas beautifulsoup4 twilio numpy
            # Install pandas_ta from our forked version with the fix
            pip install git+https://github.com/twopirllc/pandas-ta.git@development
          fi
          
          # Install the package from the current directory
          if [ -f setup.py ] || [ -f pyproject.toml ]; then
            pip install -e .
          else
            # If no setup files exist, create a simple setup.py and install
            echo "Creating temporary setup.py for package installation"
            cat > setup.py << 'EOF'
            from setuptools import setup, find_packages
            
            setup(
                name="nifty_bot",
                version="0.1",
                packages=find_packages(),
                py_modules=["nifty_telegram_bot_github"],
            )
            EOF
            pip install -e .
          fi
          
          # List installed packages to verify
          pip list | grep -E "nifty|pandas-ta" || echo "Packages not found in pip list"
      
      - name: Send startup notification
        run: |
          echo "Sending bot startup notification..."
          if [ -n "${{ secrets.TELEGRAM_API_KEY }}" ] && [ -n "${{ secrets.TELEGRAM_CHAT_ID }}" ]; then
            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_API_KEY }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="ðŸš€ Nifty Bot Analysis started running at $(date)"
          fi
      
      - name: Run Nifty Bot Script with NaN fix
        id: run_script
        continue-on-error: true
        env:
          TELEGRAM_API_KEY: ${{ secrets.TELEGRAM_API_KEY }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          WHATSAPP_ADMIN: ${{ secrets.WHATSAPP_ADMIN }}
          WHATSAPP_GROUP: ${{ secrets.WHATSAPP_GROUP }}
          TWILIO_ACCOUNT_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
          TWILIO_AUTH_TOKEN: ${{ secrets.TWILIO_AUTH_TOKEN }}
          TWILIO_FROM_NUMBER: ${{ secrets.TWILIO_FROM_NUMBER }}
        run: |
          # Create a Python script with the fix and import
          cat > run_script.py << 'EOF'
          import numpy as np
          np.NaN = np.nan  # Add NaN to numpy namespace
          
          try:
              import nifty_telegram_bot_github
              print('Successfully imported and ran nifty_telegram_bot_github')
          except Exception as e:
              import traceback
              print(f'Error running nifty_telegram_bot_github: {e}')
              traceback.print_exc()
              exit(1)
          EOF
          
          # Run the script
          python run_script.py
      
      - name: Check for errors
        if: steps.run_script.outcome == 'failure'
        run: |
          echo "Script execution failed. Sending notification..."
          # If you have Telegram integration already, you can send failure notification
          if [ -n "${{ secrets.TELEGRAM_API_KEY }}" ] && [ -n "${{ secrets.TELEGRAM_CHAT_ID }}" ]; then
            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_API_KEY }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="âš ï¸ Nifty Bot Analysis failed to run. Please check GitHub Actions logs."
          fi
      
      - name: Upload logs on failure
        if: steps.run_script.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: error-logs
          path: |
            *.log
            *.txt
          retention-days: 5
